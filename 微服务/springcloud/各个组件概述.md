### 微服务概述
- 按业务划分服务,服务与服务之间无耦合
- 独立的基础组件,如数据库\缓存
- 服务间采用http+json的通信方式
- 跨语言\跨平台
---
---

### spring cloud组件
微服务的解决方案

#### 一. 注册中心Eureka

##### 1.服务注册,注册过程:
1. 客户端在注册中心注册,将自己的信息(服务名\IP地址\以及对外提供的服务)
2. 注册中心返回一份列表,此列表包含了所有向注册中心注册的服务信息,客户端将此列表缓存在本地

##### 2.注册延迟
1. 客户端启动后默认延迟40秒向注册中心注册,所以客户端启动后并不能马上得到服务列表信息

##### 3.服务续约
1. 客户端默认每隔30秒向注册中心发送心跳消息
2. 注册中心返回注册列表,若此列表与缓存的列表信息不同,刷新缓存

##### 4.服务剔除
1. 当客户端连续90秒没有向注册中心发送心跳消息时,该服务实例从服务列表中剔除
---
#### 二. 负载均衡ribbon
常用的负载均衡的方式:
- 独立进程单元,通过负载均衡策略将请求分发到不同的执行单元上,如:ngnix
- 将负载均衡逻辑以代码形式封装到客户端,由于客户端维护了一份服务列表,就可以通过负载均衡算法将请求分发到多个server端
##### 1.ribbon使用方式
- 与RestTemplate结合使用
- feign集成ribbon
##### 2.可自选的负载均衡策略
- 选择最小请求数
- 轮询
- 随机选择一个server
- 根据响应时间去分配一个weight,weight越低,被选择的可能性就越低

#### 三. 声明式调用feign     
目的 : 将java http客户端的调用过程变得简单

feign的工作原理
- 先声明一个feign client
```
@FeignClient(value = "eureka-client")
public interface EurekaClientFeign {
    @GetMapping(value = "/helloWord")
    String helloWord(@RequestParam(value = "name") String name);
}
```
- 程序启动后扫描将有被@FeignClient修饰的接口,将接口名和注解信息一起取出,得到该接口的BeanDefinition,注入到IOC容器中
- 根据JDK动态代理生成EurekaClientFeign接口的实现类,其中实现类中的每个方法封装了http调用远程服务端的具体实现
- 将代理类注入到@Autowired修饰的变量上

#### 四. 熔断器Hystrix
雪崩效应:
- 一个请求到达服务调用者A,调用B\C\D服务
- 假如B服务因为网络故障,导致服务调用者处于阻塞状态,等待A服务的响应
- 高并发情况下,大量请求到达A,也调用B\C\D服务,导致A大量的服务线程处于阻塞状态
- A一旦线程资源被耗尽,服务调用者提供的服务也将处于不可用状态
- 则依赖A的服务也处于不可用状态,雪崩效应产生
- 整个服务系统不可用

##### 1.Hystrix的工作机制
- 假如A服务调用B服务,A服务调用B服务的失败次数在一定时间内小于设定的阈值时,熔断器处于关闭状态
- 当A服务调用B服务失败的次数大于预定的阈值时,Hystrix判定B服务的Api接口出现了故障吗,打开熔断器,则A服务快速执行失败的逻辑,请求的线程不会处于阻塞状态.
- 处于打开状态的熔断器在一段时间后,会处于半打开状态,并将一定数量的请求执行正常逻辑,剩余请求则快速执行失败逻辑,若执行正常逻辑的请求失败了,则熔断器继续打开,若成功了,则熔断器关闭 

### 五. 路由网关zuul
网关目的：
- 实现负载均衡、使请求按某种负载均衡到指定的的服务中去
- 权限校验
- 监控，实时日志输出
- 流量监控，在高流量的情况下进行服务降级


##### 1.zuul工作原理
zuul的核心是一系列的过滤器，在请求发起和响应返回期间执行一系列的过滤器

过滤器分类：
- PRE过滤器：这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等
- ROUTING：这种过滤器将请求路由到微服务。这种过滤器用于构建发送给微服务的请求，并使用Apache HttpClient或Netfilx Ribbon请求微服务。
- POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等。
- ERROR：在其他阶段发生错误时执行该过滤器。

当一个客户端Request请求进入zuul网关服务时，先进入pre filter，进行一系列的验证、操作、判断。然后交给routing filter进行路由转发到具体的微服务实例进行逻辑处理并返回。处理完成后交给post filter处理，处理完成后返回客户端

注意：
- zuul也需配置熔断器
- 并且采用的是异步阻塞模式
- 横向扩展，当负载过高时，可以添加实例来解决性能瓶颈





